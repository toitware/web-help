<!doctype html><html data-stencil-build="jkahvjks" class="hydrated"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><style sty-id="sc-discord-messages">@import url('https://fonts.bunny.net/css?family=roboto:400,500,700');@font-face{font-family:'Whitney';src:url('https://cdn.jsdelivr.net/gh/ItzDerock/discord-components@master/assets/fonts/Book.woff') format('woff');font-weight:400;font-display:swap}@font-face{font-family:'Whitney';src:url('https://cdn.jsdelivr.net/gh/ItzDerock/discord-components@master/assets/fonts/Medium.woff') format('woff');font-weight:500;font-display:swap}@font-face{font-family:'Whitney';src:url('https://cdn.jsdelivr.net/gh/ItzDerock/discord-components@master/assets/fonts/Semibold.woff') format('woff');font-weight:600;font-display:swap}@font-face{font-family:'Whitney';src:url('https://cdn.jsdelivr.net/gh/ItzDerock/discord-components@master/assets/fonts/Bold.woff') format('woff');font-weight:700;font-display:swap}.discord-messages{color:#fff;background-color:#36393e;display:block;font-size:16px;font-family:Whitney, 'Source Sans Pro', ui-sans-serif, system-ui, -apple-system, 'system-ui', 'Segoe UI', Roboto, 'Helvetica Neue', Arial,
		sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';line-height:170%;border:1px solid rgba(255, 255, 255, 0.05)}.discord-messages.discord-light-theme{color:#747f8d;background-color:#fff;border-color:#dedede}.discord-messages.discord-no-background{background-color:unset}</style><style sty-id="sc-discord-header">.discord-header{display:flex;flex-direction:row;max-height:5rem;padding:0.5rem;gap:0.5rem;border-bottom:1px solid rgba(79, 84, 92, 0.48)}.discord-header-icon{float:left;width:5rem}.discord-header-icon>div{background-color:rgb(79, 84, 92);border-radius:50%;width:5rem;height:5rem;text-align:center;align-items:center;justify-content:center;display:flex;font-size:xx-large}.discord-header-icon>img{border-radius:50%;width:auto;height:100%}.discord-header-text{flex-grow:1}.discord-header-text-guild{font-size:1.5rem;font-weight:bold}</style><style sty-id="sc-discord-message">.discord-message{color:#dcddde;display:flex;flex-direction:column;font-size:0.9em;font-family:Whitney, 'Source Sans Pro', ui-sans-serif, system-ui, -apple-system, 'system-ui', 'Segoe UI', Roboto, 'Helvetica Neue', Arial,
		sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';padding:0px 1em;position:relative;word-wrap:break-word;-webkit-user-select:text;-moz-user-select:text;-ms-user-select:text;user-select:text;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:0 0 auto;padding-right:0;min-height:1.375rem;padding-right:48px !important;margin-top:1.0625rem}.discord-message .discord-message-inner{display:flex;position:relative;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:0 0 auto}.discord-message.discord-highlight-mention,.discord-message.discord-highlight-ephemeral{padding-right:5px;position:relative}.discord-message.discord-highlight-mention::before,.discord-message.discord-highlight-ephemeral::before{content:'';position:absolute;display:block;top:0;left:0;bottom:0;pointer-events:none;width:2px}.discord-message.discord-highlight-mention{background-color:rgba(250, 166, 26, 0.1)}.discord-light-theme .discord-message.discord-highlight-mention{background-color:rgba(250, 166, 26, 0.1)}.discord-message.discord-highlight-mention:hover{background-color:rgba(250, 166, 26, 0.08)}.discord-light-theme .discord-message.discord-highlight-mention:hover{background-color:rgba(250, 166, 26, 0.2)}.discord-message.discord-highlight-mention::before{background-color:#faa61a}.discord-message.discord-highlight-ephemeral{background-color:rgba(88, 101, 242, 0.05)}.discord-light-theme .discord-message.discord-highlight-ephemeral{background-color:rgba(250, 166, 26, 0.1)}.discord-message.discord-highlight-ephemeral:hover{background-color:rgba(88, 101, 242, 0.1)}.discord-message.discord-highlight-ephemeral::before{background-color:#5865f2}.discord-light-theme .discord-message{color:#2e3338;border-color:#eceeef}.discord-message a{color:#00aff4;font-weight:normal;text-decoration:none}.discord-message a:hover{text-decoration:underline}.discord-light-theme .discord-message a{color:#00b0f4}.discord-message a:hover{text-decoration:underline}.discord-message .discord-author-avatar{margin-right:16px;margin-top:5px;min-width:40px;z-index:1}.discord-message .discord-author-avatar img{width:40px;height:40px;border-radius:50%}.discord-message .discord-message-timestamp{color:#72767d;font-size:12px;margin-left:3px}.discord-light-theme .discord-message .discord-message-timestamp{color:#747f8d}.discord-message .discord-message-edited{color:#72767d;font-size:10px}.discord-light-theme .discord-message .discord-message-edited{color:#99aab5}.discord-message .discord-message-content{width:100%;line-height:160%;font-weight:normal;padding-top:2px}.discord-message .discord-message-body{font-size:1rem;font-weight:400;word-break:break-word;position:relative}.discord-message .discord-message-body strong{font-weight:700}.discord-message .discord-message-body em{font-style:italic}.discord-message .discord-message-body u{text-decoration-color:rgb(220, 221, 222);text-decoration-line:underline;text-decoration-style:solid;text-decoration-thickness:auto}.discord-message .discord-message-body pre{border:1px solid #202225;border-radius:4px}.discord-message .discord-message-body code{background:#2f3136;white-space:break-spaces;font-family:Consolas, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono,
		Liberation Mono, Nimbus Mono L, Monaco, Courier New, Courier, monospace}.discord-light-theme .discord-message .discord-message-timestamp,.discord-compact-mode .discord-message:hover .discord-message-timestamp,.discord-compact-mode.discord-light-theme .discord-message:hover .discord-message-timestamp{color:#99aab5}.discord-compact-mode.discord-light-theme .discord-message .discord-message-timestamp{color:#d1d9de}.discord-compact-mode .discord-message .discord-message-timestamp{display:inline-block;width:3.1rem;text-align:right;font-size:0.6875rem;line-height:1.375rem;margin-right:0.25rem;margin-left:0;text-indent:0}.discord-compact-mode .discord-message{margin-top:unset}.discord-compact-mode .discord-message .discord-message-body{line-height:1.375rem;padding-left:10px;text-indent:-6px}.discord-compact-mode .discord-message .discord-message-compact-indent{padding-left:10px}.discord-message:first-child{margin-top:0.5rem}.discord-message:last-child{margin-bottom:0.5rem;border-bottom-width:0}.discord-message .discord-message-markup{font-size:1rem;line-height:1.375rem;word-wrap:break-word;user-select:text;font-weight:400}.discord-compact-mode .discord-author-avatar{display:none}.discord-message:hover{background-color:rgba(4, 4, 5, 0.07)}.discord-light-theme .discord-message:hover{background-color:rgba(6, 6, 7, 0.02)}.discord-message.discord-message-has-thread:after{width:2rem;left:2.2rem;top:1.75rem;border-left:2px solid #4f545c;border-bottom:2px solid #4f545c;border-bottom-left-radius:8px;bottom:29px;content:'';position:absolute}.discord-light-theme .discord-message.discord-message-has-thread:after{border-color:#747f8d}.discord-message-ephemeral{color:#72767d;margin-top:4px;font-size:12px;font-weight:400;color:#72767d}.discord-light-theme .discord-message-ephemeral{color:#747f8d}.discord-message-ephemeral .discord-message-ephemeral-link{color:#00aff4;font-weight:500;cursor:pointer}.discord-message-ephemeral .discord-message-ephemeral-link:hover{text-decoration:underline}.discord-message-ephemeral .discord-message-ephemeral-icon{margin-right:4px;vertical-align:text-bottom}.discord-message .discord-author-info{display:inline-flex;align-items:center;font-size:16px;margin-right:0.25rem}.discord-compact-mode .discord-message .discord-author-info{margin-right:0}.discord-message .discord-author-info .discord-author-username{color:#fff;font-size:1em;font-weight:500}.discord-light-theme .discord-message .discord-author-info .discord-author-username{color:#23262a}.discord-message .discord-author-info .discord-application-tag{background-color:#5865f2;color:#fff;font-size:0.625em;margin-left:4px;border-radius:3px;line-height:100%;text-transform:uppercase;display:flex;align-items:center;height:0.9375rem;padding:0 0.275rem;margin-top:0.075em;border-radius:0.1875rem}.discord-message .discord-author-info .discord-application-tag.discord-application-tag-op{background-color:#c9cdfb;color:#4752c4;border-radius:0.4rem}.discord-message .discord-author-info .discord-application-tag-verified{display:inline-block;width:0.9375rem;height:0.9375rem;margin-left:-0.25rem}.discord-message .discord-author-info .discord-author-role-icon{margin-left:0.25rem;vertical-align:top;height:calc(1rem + 4px);width:calc(1rem + 4px)}.discord-compact-mode .discord-message .discord-author-info .discord-author-username{margin-left:8px;margin-right:4px}.discord-compact-mode .discord-message .discord-author-info .discord-application-tag{margin-left:0;margin-left:5px;margin-right:5px;padding-left:10px;padding-right:4px}.discord-compact-mode .discord-message .discord-author-info .discord-application-tag-verified{margin-right:0.7em;margin-left:-0.7em}</style><style sty-id="sc-discord-code-block">.discord-code-block-pre{background-color:#2f3136;font-family:'Consolas', 'Courier New', Courier, monospace;margin-top:0.25rem;white-space:pre-wrap}.discord-code-block-pre--multiline{display:block;margin-bottom:0.5rem;margin-top:0.25em;padding:0.5em;border:1px solid #202225;border-radius:4px;color:#b9bbbe;font-size:0.875rem}.discord-code-block-pre--multiline.hljs{background-color:#2f3136;color:#b9bbbe}.discord-embed .discord-code-block-pre{background-color:#202225}.discord-embed .discord-code-block-pre .hljs{background-color:#202225}code.hljs{padding:unset !important}/*!
  Theme: Helios
  Author: Alex Meyer (https://github.com/reyemxela)
  License: ~ MIT (or more permissive) [via base16-schemes-source]
  Maintainer: @highlightjs/core-team
  Version: 2021.09.0
*/pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{color:#d5d5d5;background:#1d2021}.hljs ::selection,.hljs::selection{background-color:#53585b;color:#d5d5d5}.hljs-comment{color:#6f7579}.hljs-tag{color:#cdcdcd}.hljs-operator,.hljs-punctuation,.hljs-subst{color:#d5d5d5}.hljs-operator{opacity:.7}.hljs-bullet,.hljs-deletion,.hljs-name,.hljs-selector-tag,.hljs-template-variable,.hljs-variable{color:#d72638}.hljs-attr,.hljs-link,.hljs-literal,.hljs-number,.hljs-symbol,.hljs-variable.constant_{color:#eb8413}.hljs-class .hljs-title,.hljs-title,.hljs-title.class_{color:#f19d1a}.hljs-strong{font-weight:700;color:#f19d1a}.hljs-addition,.hljs-code,.hljs-string,.hljs-title.class_.inherited__{color:#88b92d}.hljs-built_in,.hljs-doctag,.hljs-keyword.hljs-atrule,.hljs-quote,.hljs-regexp{color:#1ba595}.hljs-attribute,.hljs-function .hljs-title,.hljs-section,.hljs-title.function_,.ruby .hljs-property{color:#1e8bac}.diff .hljs-meta,.hljs-keyword,.hljs-template-tag,.hljs-type{color:#be4264}.hljs-emphasis{color:#be4264;font-style:italic}.hljs-meta,.hljs-meta .hljs-keyword,.hljs-meta .hljs-string{color:#c85e0d}.hljs-meta .hljs-keyword,.hljs-meta-keyword{font-weight:700}</style><style sty-id="sc-discord-embed">.discord-embed{color:#dcddde;display:flex;font-size:13px;line-height:150%;margin-bottom:2px;margin-top:2px}.discord-light-theme .discord-embed{color:#2e3338}.discord-embed .discord-left-border{background-color:#202225;border-radius:4px 0 0 4px;flex-shrink:0;width:4px}.discord-light-theme .discord-embed .discord-left-border{background-color:#e3e5e8}.discord-embed .discord-embed-root{display:grid;grid-auto-flow:row;grid-row-gap:0.25rem;min-height:0;min-width:0;text-indent:0}.discord-embed .discord-embed-wrapper{background-color:#2f3136;max-width:520px;border:1px solid rgba(46, 48, 54, 0.6);border-radius:0 4px 4px 0;justify-self:start;align-self:start;display:grid;box-sizing:border-box}.discord-light-theme .discord-embed .discord-embed-wrapper{background-color:rgba(249, 249, 249, 0.3);border-color:rgba(205, 205, 205, 0.3)}.discord-embed .discord-embed-wrapper .discord-embed-grid{display:inline-grid;grid-template-columns:auto -webkit-min-content;grid-template-columns:auto min-content;grid-template-columns:auto;grid-template-rows:auto;padding:0.5rem 1rem 1rem 0.75rem}.discord-embed .discord-embed-thumbnail{border-radius:4px;flex-shrink:0;grid-column:2/2;grid-row:1/8;justify-self:end;margin-left:16px;margin-top:8px;max-height:80px;max-width:80px;object-fit:contain;object-position:top center}.discord-embed .discord-embed-author{-webkit-box-align:center;align-items:center;color:#fff;font-size:14px;display:flex;font-weight:600;grid-column:1 / 1;margin-top:8px;min-width:0}.discord-light-theme .discord-embed .discord-embed-author{color:#4f545c}.discord-embed .discord-embed-author a{color:#fff;font-weight:600}.discord-light-theme .discord-embed .discord-embed-author a{color:#4f545c}.discord-embed .discord-embed-author .discord-author-image{border-radius:50%;height:24px;margin-right:8px;width:24px}.discord-embed .discord-embed-provider{font-size:0.75rem;line-height:1rem;font-weight:400;grid-column:1/1;margin-top:8px;unicode-bidi:plaintext;text-align:left}.discord-light-theme .discord-embed .discord-embed-provider{color:#4f545c}.discord-embed .discord-embed-title{-webkit-box-align:center;align-items:center;color:#fff;display:inline-block;font-size:1rem;font-weight:600;grid-column:1 / 1;margin-top:8px;min-width:0}.discord-embed .discord-embed-title a{color:#00aff4;font-weight:600}.discord-embed .discord-embed-image{border-radius:4px;max-width:100%}.discord-embed .discord-embed-media{border-radius:4px;contain:paint;display:block;grid-column:1/1;margin-top:16px}.discord-embed .discord-embed-media.discord-embed-media-video{height:225px}.discord-embed .discord-embed.media .discord-embed-image{overflow:hidden;position:relative;user-select:text}.discord-embed .discord-embed-media .discord-embed-video{-webkit-box-align:center;-webkit-box-pack:center;align-items:center;border-radius:0;cursor:pointer;display:flex;height:100%;justify-content:center;max-height:100%;width:100%;width:400px;height:225px;left:0px;top:0px}.discord-embed-custom-emoji{display:inline-block}.discord-embed-custom-emoji .discord-embed-custom-emoji-image{width:18px;height:18px;vertical-align:bottom}</style><style sty-id="sc-discord-embed-description">.discord-embed .discord-embed-description{font-size:0.875rem;font-weight:400;grid-column:1/1;line-height:1.125rem;margin-top:8px;min-width:0;white-space:pre-line}.discord-embed .discord-embed-description pre{margin:0;margin-top:6px}.discord-embed .discord-embed-description img.emoji{width:22px;height:22px}.discord-embed .discord-embed-description blockquote{position:relative;padding:0 8px 0 12px;margin:0}.discord-embed .discord-embed-description blockquote::before{content:'';display:block;position:absolute;left:0;height:100%;width:4px;border-radius:4px;background-color:#4f545c}.discord-light-theme .discord-embed-description blockquote::before{background-color:#c7ccd1}.discord-embed .discord-embed-description .spoiler{background-color:#202225;color:transparent;cursor:pointer}.discord-light-theme .discord-embed .discord-embed-description .spoiler{background-color:#b9bbbe}.discord-embed .discord-embed-description .spoiler:hover{background-color:rgba(32, 34, 37, 0.8)}.discord-light-theme .discord-embed .discord-embed-description .spoiler:hover{background-color:rgba(185, 187, 190, 0.8)}.discord-embed .discord-embed-description .spoiler:active{color:inherit;background-color:hsla(0, 0%, 100%, 0.1)}.discord-light-theme .discord-embed .discord-embed-description .spoiler:active{background-color:rgba(0, 0, 0, 0.1)}</style><link rel="icon" type="image/png" href="https://cdn.discordapp.com/icons/918498540232253480/31a743207f2d3b681494445b982fabcd.png?size=16"><title>WebSocket, "Invalid frame header"</title><script>document.addEventListener("click",t=>{let e=t.target;if(!e)return;let o=e?.getAttribute("data-goto");if(o){let r=document.getElementById(`m-${o}`);r?(r.scrollIntoView({behavior:"smooth",block:"center"}),r.style.backgroundColor="rgba(148, 156, 247, 0.1)",r.style.transition="background-color 0.5s ease",setTimeout(()=>{r.style.backgroundColor="transparent"},1e3)):console.warn("Message ${goto} not found.")}});</script></head><body style="margin: 0; min-height: 100vh;"><discord-messages class="discord-messages hydrated" s-id="1" style="min-height: 100vh;"><!--r.1--><!--o.0.1--><!--o.0.2--><!--o.0.3--><!--o.0.4--><!--o.0.5--><!--o.0.6--><!--o.0.7--><!--o.0.8--><!--o.0.9--><!--o.0.10--><!--o.0.11--><!--o.0.12--><!--o.0.13--><!--o.0.14--><!--o.0.15--><!--o.0.16--><!--o.0.17--><!--o.0.18--><!--o.0.19--><!--o.0.20--><!--s.1.0.0.0.--><discord-header guild="Toit" channel="WebSocket, &quot;Invalid frame header&quot;" icon="https://cdn.discordapp.com/icons/918498540232253480/31a743207f2d3b681494445b982fabcd.webp?size=128" class="discord-header hydrated" s-id="2" c-id="0.1"><!--r.2--><!--o.0.21--><div class="discord-header-icon" c-id="2.0.0.0"><img src="https://cdn.discordapp.com/icons/918498540232253480/31a743207f2d3b681494445b982fabcd.webp?size=128" alt="guild icon" c-id="2.1.1.0"></div><div class="discord-header-text" c-id="2.2.0.1"><div class="discord-header-text-guild" c-id="2.3.1.0"><!--t.2.4.2.0-->Toit</div><div class="discord-header-text-channel" c-id="2.5.1.1"><!--t.2.6.2.0-->#WebSocket, "Invalid frame header"</div><!--s.2.7.1.2.--><!--t.0.21-->Thread channel in help</div></discord-header><discord-message id="m-1190382880279506964" timestamp="12/29/2023 07:56 PM" edited="false" highlight="false" profile="680454302786912427" class="discord-message hydrated" s-id="3" c-id="0.2"><!--r.3--><!--o.0.22--><!--o.0.23--><!--o.0.24--><!--o.0.25--><!--o.0.26--><!--o.0.27--><!--o.0.28--><!--o.0.29--><!--o.0.30--><!--o.0.31--><!--o.0.32--><!--o.0.33--><!--o.0.34--><!--o.0.35--><!--o.0.36--><!--o.0.37--><!--o.0.38--><!--o.0.39--><!--o.0.40--><!--o.0.41--><!--s.3.0.0.0.reply--><div class="discord-message-inner" c-id="3.1.0.1"><div class="discord-author-avatar" c-id="3.2.1.0"><img src="https://cdn.discordapp.com/embed/avatars/0.png" alt="davidg238" c-id="3.3.2.0"></div><div class="discord-message-content" c-id="3.4.1.1"><span class="discord-author-info" c-id="3.5.2.0"><span class="discord-author-username" c-id="3.6.3.0"><!--t.3.7.4.0-->davidg238</span><!--t.3.8.3.1--> </span><span class="discord-message-timestamp" c-id="3.9.2.1"><!--t.3.10.3.0-->12/29/2023 07:56 PM</span><div class="discord-message-body" c-id="3.11.2.2"><span class="discord-message-markup" c-id="3.12.3.0"><!--s.3.13.4.0.--><!--t.0.22-->When trying to migrate the example at <a href="https://github.com/toitlang/toit/discussions/1198" target="_blank" rel="noreferrer" c-id="0.23">https://github.com/toitlang/toit/discussions/1198</a><!--t.0.24--> from the pkg-websocket to http.web_socket, I revised <discord-inline-code class="hydrated" s-id="4" c-id="0.25"><!--r.4--><!--o.0.42--><code c-id="4.0.0.0"><!--s.4.1.1.0.--><!--t.0.42-->main</code></discord-inline-code><!--t.0.26--> initially to look like:<br c-id="0.27"><discord-code-block language="" code="import http
import http.request show RequestIncoming
import http.web_socket
import net

/**
Example that demonstrates a web-socket server.
The server updates a counter for button presses.
*/

network := net.open
addr_str := network.address.stringify
server := http.Server

main:
  print &quot;Open a browser on: $network.address:8080&quot;
  sessions := {:}
  server.listen network 8080:: | request/RequestIncoming response/http.ResponseWriter |
    print &quot;enter handler&quot;
    websocket := server.web_socket request response
    if websocket:
      print &quot;ws is: $websocket&quot;
    else:
      print &quot;request $request.method $request.path $request.body.read&quot;
    if request.path == &quot;/&quot;:
      response.write spa
    else:
      print &quot;request $request.method $request.path $request.body.read failed&quot;
    print &quot;exit handler&quot;" class="discord-code-block-pre discord-code-block-pre--multiline language hydrated" s-id="5" c-id="0.28"><!--r.5--><code class="hljs language-plaintext" c-id="5.0.0.0">import http
import http.request show RequestIncoming
import http.web_socket
import net

/**
Example that demonstrates a web-socket server.
The server updates a counter for button presses.
*/

network := net.open
addr_str := network.address.stringify
server := http.Server

main:
  print "Open a browser on: $network.address:8080"
  sessions := {:}
  server.listen network 8080:: | request/RequestIncoming response/http.ResponseWriter |
    print "enter handler"
    websocket := server.web_socket request response
    if websocket:
      print "ws is: $websocket"
    else:
      print "request $request.method $request.path $request.body.read"
    if request.path == "/":
      response.write spa
    else:
      print "request $request.method $request.path $request.body.read failed"
    print "exit handler"</code></discord-code-block><br c-id="0.29"><!--t.0.30-->When the page loads, I get:<br c-id="0.31"><discord-code-block language="" code="WebSocket connection to 'ws://192.168.0.174:8080/' failed: Invalid frame header open-ws-connection @ (index):74" class="discord-code-block-pre discord-code-block-pre--multiline language hydrated" s-id="6" c-id="0.32"><!--r.6--><code class="hljs language-plaintext" c-id="6.0.0.0">WebSocket connection to 'ws://192.168.0.174:8080/' failed: Invalid frame header open-ws-connection @ (index):74</code></discord-code-block><br c-id="0.33"><!--t.0.34-->which corresponds to the line:<br c-id="0.35"><discord-code-block language="" code="ws = new WebSocket('ws://192.168.0.174:8080');" class="discord-code-block-pre discord-code-block-pre--multiline language hydrated" s-id="7" c-id="0.36"><!--r.7--><code class="hljs language-plaintext" c-id="7.0.0.0">ws = new WebSocket('ws://192.168.0.174:8080');</code></discord-code-block><br c-id="0.37"><!--t.0.38-->in the page javascript.<br c-id="0.39"><!--t.0.40-->Is this a bug in the new websocket code or cockpit error (as Session.upgrade is replaced)?</span><!--t.3.14.3.1--> </div><div class="discord-message-compact-indent" c-id="3.15.2.3"><!--s.3.16.3.0.embeds--><discord-embed embed-title="Using websockets to update a browser page 路 toitlang toit 路 Discuss..." slot="embeds" color="#1e2327" thumbnail="https://images-ext-1.discordapp.net/external/B06QitRHywNMSkwE7cYLBg7V4Ys6qAmBWr4bPGHb-Yc/https/opengraph.githubassets.com/955446140f6419183ce8e3f4585c4c5988a07dd5fd77c15ec0536b528eeefe55/toitlang/toit/discussions/1198" url="https://github.com/toitlang/toit/discussions/1198" class="hydrated" s-id="8" c-id="0.41"><!--r.8--><!--o.0.43--><div class="discord-embed" c-id="8.0.0.0"><div class="discord-left-border" c-id="8.1.1.0" style="background-color: #1e2327;"></div><div class="discord-embed-root" c-id="8.2.1.1"><div class="discord-embed-wrapper" c-id="8.3.2.0"><div class="discord-embed-grid" c-id="8.4.3.0"><div class="discord-embed-title" c-id="8.5.4.0"><a href="https://github.com/toitlang/toit/discussions/1198" target="_blank" rel="noopener noreferrer" c-id="8.6.5.0"><!--t.8.7.6.0-->Using websockets to update a browser page 路 toitlang toit 路 Discuss...</a></div><!--s.8.8.4.1.description--><discord-embed-description slot="description" class="discord-embed-description hydrated" s-id="9" c-id="0.43"><!--r.9--><!--o.0.44--><!--s.9.0.0.0.--><!--t.0.44-->A toy sample, cobbled together from the existing server and websocket samples. It show a device generating a webpage and updating the page after user interactions, without a manual page refresh. Op...</discord-embed-description><!--s.8.9.4.2.fields--><img src="https://images-ext-1.discordapp.net/external/B06QitRHywNMSkwE7cYLBg7V4Ys6qAmBWr4bPGHb-Yc/https/opengraph.githubassets.com/955446140f6419183ce8e3f4585c4c5988a07dd5fd77c15ec0536b528eeefe55/toitlang/toit/discussions/1198" alt="" class="discord-embed-thumbnail" c-id="8.10.4.3"><!--s.8.11.4.4.footer--></div></div></div></div></discord-embed><!--s.3.17.3.1.attachments--><!--s.3.18.3.2.components--><!--s.3.19.3.3.reactions--><!--s.3.20.3.4.thread--></div></div></div></discord-message><discord-message id="m-1191668881354403841" timestamp="01/02/2024 09:06 AM" edited="false" highlight="false" profile="948233689295355995" class="discord-message hydrated" s-id="10" c-id="0.3"><!--r.10--><!--o.0.45--><!--s.10.0.0.0.reply--><div class="discord-message-inner" c-id="10.1.0.1"><div class="discord-author-avatar" c-id="10.2.1.0"><img src="https://cdn.discordapp.com/avatars/948233689295355995/92a901002511c7fe73c8d02b558ddbdb.webp?size=64" alt="erikcorry" c-id="10.3.2.0"></div><div class="discord-message-content" c-id="10.4.1.1"><span class="discord-author-info" c-id="10.5.2.0"><span class="discord-author-username" c-id="10.6.3.0"><!--t.10.7.4.0-->erikcorry</span><!--t.10.8.3.1--> </span><span class="discord-message-timestamp" c-id="10.9.2.1"><!--t.10.10.3.0-->01/02/2024 09:06 AM</span><div class="discord-message-body" c-id="10.11.2.2"><span class="discord-message-markup" c-id="10.12.3.0"><!--s.10.13.4.0.--><!--t.0.45-->The way it's expected to work is that the websocket connection is on a particular path.</span><!--t.10.14.3.1--> </div><div class="discord-message-compact-indent" c-id="10.15.2.3"><!--s.10.16.3.0.embeds--><!--s.10.17.3.1.attachments--><!--s.10.18.3.2.components--><!--s.10.19.3.3.reactions--><!--s.10.20.3.4.thread--></div></div></div></discord-message><discord-message id="m-1191669015844765856" timestamp="01/02/2024 09:07 AM" edited="false" highlight="false" profile="948233689295355995" class="discord-message hydrated" s-id="11" c-id="0.4"><!--r.11--><!--o.0.46--><!--s.11.0.0.0.reply--><div class="discord-message-inner" c-id="11.1.0.1"><div class="discord-author-avatar" c-id="11.2.1.0"><img src="https://cdn.discordapp.com/avatars/948233689295355995/92a901002511c7fe73c8d02b558ddbdb.webp?size=64" alt="erikcorry" c-id="11.3.2.0"></div><div class="discord-message-content" c-id="11.4.1.1"><span class="discord-author-info" c-id="11.5.2.0"><span class="discord-author-username" c-id="11.6.3.0"><!--t.11.7.4.0-->erikcorry</span><!--t.11.8.3.1--> </span><span class="discord-message-timestamp" c-id="11.9.2.1"><!--t.11.10.3.0-->01/02/2024 09:07 AM</span><div class="discord-message-body" c-id="11.11.2.2"><span class="discord-message-markup" c-id="11.12.3.0"><!--s.11.13.4.0.--><!--t.0.46-->For example ws://192.168.0.174.8080/ws</span><!--t.11.14.3.1--> </div><div class="discord-message-compact-indent" c-id="11.15.2.3"><!--s.11.16.3.0.embeds--><!--s.11.17.3.1.attachments--><!--s.11.18.3.2.components--><!--s.11.19.3.3.reactions--><!--s.11.20.3.4.thread--></div></div></div></discord-message><discord-message id="m-1191669172288106496" timestamp="01/02/2024 09:07 AM" edited="false" highlight="false" profile="948233689295355995" class="discord-message hydrated" s-id="12" c-id="0.5"><!--r.12--><!--o.0.47--><!--s.12.0.0.0.reply--><div class="discord-message-inner" c-id="12.1.0.1"><div class="discord-author-avatar" c-id="12.2.1.0"><img src="https://cdn.discordapp.com/avatars/948233689295355995/92a901002511c7fe73c8d02b558ddbdb.webp?size=64" alt="erikcorry" c-id="12.3.2.0"></div><div class="discord-message-content" c-id="12.4.1.1"><span class="discord-author-info" c-id="12.5.2.0"><span class="discord-author-username" c-id="12.6.3.0"><!--t.12.7.4.0-->erikcorry</span><!--t.12.8.3.1--> </span><span class="discord-message-timestamp" c-id="12.9.2.1"><!--t.12.10.3.0-->01/02/2024 09:07 AM</span><div class="discord-message-body" c-id="12.11.2.2"><span class="discord-message-markup" c-id="12.12.3.0"><!--s.12.13.4.0.--><!--t.0.47-->Then in the handler you recognize the path and don't try to upgrade to websocket protocol unless the path matches.</span><!--t.12.14.3.1--> </div><div class="discord-message-compact-indent" c-id="12.15.2.3"><!--s.12.16.3.0.embeds--><!--s.12.17.3.1.attachments--><!--s.12.18.3.2.components--><!--s.12.19.3.3.reactions--><!--s.12.20.3.4.thread--></div></div></div></discord-message><discord-message id="m-1191669339523395684" timestamp="01/02/2024 09:08 AM" edited="false" highlight="false" profile="948233689295355995" class="discord-message hydrated" s-id="13" c-id="0.6"><!--r.13--><!--o.0.48--><!--s.13.0.0.0.reply--><div class="discord-message-inner" c-id="13.1.0.1"><div class="discord-author-avatar" c-id="13.2.1.0"><img src="https://cdn.discordapp.com/avatars/948233689295355995/92a901002511c7fe73c8d02b558ddbdb.webp?size=64" alt="erikcorry" c-id="13.3.2.0"></div><div class="discord-message-content" c-id="13.4.1.1"><span class="discord-author-info" c-id="13.5.2.0"><span class="discord-author-username" c-id="13.6.3.0"><!--t.13.7.4.0-->erikcorry</span><!--t.13.8.3.1--> </span><span class="discord-message-timestamp" c-id="13.9.2.1"><!--t.13.10.3.0-->01/02/2024 09:08 AM</span><div class="discord-message-body" c-id="13.11.2.2"><span class="discord-message-markup" c-id="13.12.3.0"><!--s.13.13.4.0.--><!--t.0.48-->Currently it always tries to upgrade every request to websocket, which gives 400 No nonce errors  that you can see in the browser console.</span><!--t.13.14.3.1--> </div><div class="discord-message-compact-indent" c-id="13.15.2.3"><!--s.13.16.3.0.embeds--><!--s.13.17.3.1.attachments--><!--s.13.18.3.2.components--><!--s.13.19.3.3.reactions--><!--s.13.20.3.4.thread--></div></div></div></discord-message><discord-message id="m-1191669574257618944" timestamp="01/02/2024 09:09 AM" edited="false" highlight="false" profile="948233689295355995" class="discord-message hydrated" s-id="14" c-id="0.7"><!--r.14--><!--o.0.49--><!--o.0.50--><!--o.0.51--><!--s.14.0.0.0.reply--><div class="discord-message-inner" c-id="14.1.0.1"><div class="discord-author-avatar" c-id="14.2.1.0"><img src="https://cdn.discordapp.com/avatars/948233689295355995/92a901002511c7fe73c8d02b558ddbdb.webp?size=64" alt="erikcorry" c-id="14.3.2.0"></div><div class="discord-message-content" c-id="14.4.1.1"><span class="discord-author-info" c-id="14.5.2.0"><span class="discord-author-username" c-id="14.6.3.0"><!--t.14.7.4.0-->erikcorry</span><!--t.14.8.3.1--> </span><span class="discord-message-timestamp" c-id="14.9.2.1"><!--t.14.10.3.0-->01/02/2024 09:09 AM</span><div class="discord-message-body" c-id="14.11.2.2"><span class="discord-message-markup" c-id="14.12.3.0"><!--s.14.13.4.0.--><!--t.0.49-->And currenly when it gets a websocket request on the path "/" it first converts to websocket, but then continues with the <discord-inline-code class="hydrated" s-id="15" c-id="0.50"><!--r.15--><!--o.0.52--><code c-id="15.0.0.0"><!--s.15.1.1.0.--><!--t.0.52-->if request.path == "/"</code></discord-inline-code><!--t.0.51--> and sends it HTML on the websocket connection, which messes things up.</span><!--t.14.14.3.1--> </div><div class="discord-message-compact-indent" c-id="14.15.2.3"><!--s.14.16.3.0.embeds--><!--s.14.17.3.1.attachments--><!--s.14.18.3.2.components--><!--s.14.19.3.3.reactions--><!--s.14.20.3.4.thread--></div></div></div></discord-message><discord-message id="m-1191671542019522640" timestamp="01/02/2024 09:17 AM" edited="false" highlight="false" profile="948233689295355995" class="discord-message hydrated" s-id="16" c-id="0.8"><!--r.16--><!--o.0.53--><!--s.16.0.0.0.reply--><div class="discord-message-inner" c-id="16.1.0.1"><div class="discord-author-avatar" c-id="16.2.1.0"><img src="https://cdn.discordapp.com/avatars/948233689295355995/92a901002511c7fe73c8d02b558ddbdb.webp?size=64" alt="erikcorry" c-id="16.3.2.0"></div><div class="discord-message-content" c-id="16.4.1.1"><span class="discord-author-info" c-id="16.5.2.0"><span class="discord-author-username" c-id="16.6.3.0"><!--t.16.7.4.0-->erikcorry</span><!--t.16.8.3.1--> </span><span class="discord-message-timestamp" c-id="16.9.2.1"><!--t.16.10.3.0-->01/02/2024 09:17 AM</span><div class="discord-message-body" c-id="16.11.2.2"><span class="discord-message-markup" c-id="16.12.3.0"><!--s.16.13.4.0.--><discord-code-block language="" code="main:
  print &quot;Open a browser on: $network.address:8080&quot;
  sessions := {:}
  server.listen network 8080:: | request/RequestIncoming response/http.ResponseWriter |
    if request.path == &quot;/ws&quot;:
      websocket := server.web_socket request response
      if websocket:
        print &quot;ws is: $websocket&quot;
    else if request.path == &quot;/&quot;:
      response.write SPA
    else:
      print &quot;request $request.method $request.path $request.body.read failed&quot;
      response.headers.set &quot;Content-Type&quot; &quot;text/plain&quot;
      response.write_headers 404
      response.write &quot;Not found\n&quot;" class="discord-code-block-pre discord-code-block-pre--multiline language hydrated" s-id="17" c-id="0.53"><!--r.17--><code class="hljs language-plaintext" c-id="17.0.0.0">main:
  print "Open a browser on: $network.address:8080"
  sessions := {:}
  server.listen network 8080:: | request/RequestIncoming response/http.ResponseWriter |
    if request.path == "/ws":
      websocket := server.web_socket request response
      if websocket:
        print "ws is: $websocket"
    else if request.path == "/":
      response.write SPA
    else:
      print "request $request.method $request.path $request.body.read failed"
      response.headers.set "Content-Type" "text/plain"
      response.write_headers 404
      response.write "Not found\n"</code></discord-code-block></span><!--t.16.14.3.1--> </div><div class="discord-message-compact-indent" c-id="16.15.2.3"><!--s.16.16.3.0.embeds--><!--s.16.17.3.1.attachments--><!--s.16.18.3.2.components--><!--s.16.19.3.3.reactions--><!--s.16.20.3.4.thread--></div></div></div></discord-message><discord-message id="m-1191671730515759174" timestamp="01/02/2024 09:18 AM" edited="false" highlight="false" profile="948233689295355995" class="discord-message hydrated" s-id="18" c-id="0.9"><!--r.18--><!--o.0.54--><!--o.0.55--><!--o.0.56--><!--o.0.57--><!--o.0.58--><!--s.18.0.0.0.reply--><div class="discord-message-inner" c-id="18.1.0.1"><div class="discord-author-avatar" c-id="18.2.1.0"><img src="https://cdn.discordapp.com/avatars/948233689295355995/92a901002511c7fe73c8d02b558ddbdb.webp?size=64" alt="erikcorry" c-id="18.3.2.0"></div><div class="discord-message-content" c-id="18.4.1.1"><span class="discord-author-info" c-id="18.5.2.0"><span class="discord-author-username" c-id="18.6.3.0"><!--t.18.7.4.0-->erikcorry</span><!--t.18.8.3.1--> </span><span class="discord-message-timestamp" c-id="18.9.2.1"><!--t.18.10.3.0-->01/02/2024 09:18 AM</span><div class="discord-message-body" c-id="18.11.2.2"><span class="discord-message-markup" c-id="18.12.3.0"><!--s.18.13.4.0.--><!--t.0.54-->Then you also need to change the script to have: <discord-inline-code class="hydrated" s-id="19" c-id="0.55"><!--r.19--><!--o.0.59--><code c-id="19.0.0.0"><!--s.19.1.1.0.--><!--t.0.59-->ws = new WebSocket('ws://$(addr_str):8080/ws');</code></discord-inline-code><!--t.0.56--> with the <discord-inline-code class="hydrated" s-id="20" c-id="0.57"><!--r.20--><!--o.0.60--><code c-id="20.0.0.0"><!--s.20.1.1.0.--><!--t.0.60-->/ws</code></discord-inline-code><!--t.0.58--> at the end.</span><!--t.18.14.3.1--> </div><div class="discord-message-compact-indent" c-id="18.15.2.3"><!--s.18.16.3.0.embeds--><!--s.18.17.3.1.attachments--><!--s.18.18.3.2.components--><!--s.18.19.3.3.reactions--><!--s.18.20.3.4.thread--></div></div></div></discord-message><discord-message id="m-1191672135165419520" timestamp="01/02/2024 09:19 AM" edited="false" highlight="false" profile="948233689295355995" class="discord-message hydrated" s-id="21" c-id="0.10"><!--r.21--><!--o.0.61--><!--o.0.62--><!--o.0.63--><!--s.21.0.0.0.reply--><div class="discord-message-inner" c-id="21.1.0.1"><div class="discord-author-avatar" c-id="21.2.1.0"><img src="https://cdn.discordapp.com/avatars/948233689295355995/92a901002511c7fe73c8d02b558ddbdb.webp?size=64" alt="erikcorry" c-id="21.3.2.0"></div><div class="discord-message-content" c-id="21.4.1.1"><span class="discord-author-info" c-id="21.5.2.0"><span class="discord-author-username" c-id="21.6.3.0"><!--t.21.7.4.0-->erikcorry</span><!--t.21.8.3.1--> </span><span class="discord-message-timestamp" c-id="21.9.2.1"><!--t.21.10.3.0-->01/02/2024 09:19 AM</span><div class="discord-message-body" c-id="21.11.2.2"><span class="discord-message-markup" c-id="21.12.3.0"><!--s.21.13.4.0.--><!--t.0.61-->Another change you need is <discord-inline-code class="hydrated" s-id="22" c-id="0.62"><!--r.22--><!--o.0.64--><code c-id="22.0.0.0"><!--s.22.1.1.0.--><!--t.0.64-->--max-tasks=2</code></discord-inline-code><!--t.0.63--> at least when creating the HTTP server.</span><!--t.21.14.3.1--> </div><div class="discord-message-compact-indent" c-id="21.15.2.3"><!--s.21.16.3.0.embeds--><!--s.21.17.3.1.attachments--><!--s.21.18.3.2.components--><!--s.21.19.3.3.reactions--><!--s.21.20.3.4.thread--></div></div></div></discord-message><discord-message id="m-1191672194363834459" timestamp="01/02/2024 09:19 AM" edited="false" highlight="false" profile="948233689295355995" class="discord-message hydrated" s-id="23" c-id="0.11"><!--r.23--><!--o.0.65--><!--s.23.0.0.0.reply--><div class="discord-message-inner" c-id="23.1.0.1"><div class="discord-author-avatar" c-id="23.2.1.0"><img src="https://cdn.discordapp.com/avatars/948233689295355995/92a901002511c7fe73c8d02b558ddbdb.webp?size=64" alt="erikcorry" c-id="23.3.2.0"></div><div class="discord-message-content" c-id="23.4.1.1"><span class="discord-author-info" c-id="23.5.2.0"><span class="discord-author-username" c-id="23.6.3.0"><!--t.23.7.4.0-->erikcorry</span><!--t.23.8.3.1--> </span><span class="discord-message-timestamp" c-id="23.9.2.1"><!--t.23.10.3.0-->01/02/2024 09:19 AM</span><div class="discord-message-body" c-id="23.11.2.2"><span class="discord-message-markup" c-id="23.12.3.0"><!--s.23.13.4.0.--><discord-code-block language="" code="server := http.Server --max-tasks=2" class="discord-code-block-pre discord-code-block-pre--multiline language hydrated" s-id="24" c-id="0.65"><!--r.24--><code class="hljs language-plaintext" c-id="24.0.0.0">server := http.Server --max-tasks=2</code></discord-code-block></span><!--t.23.14.3.1--> </div><div class="discord-message-compact-indent" c-id="23.15.2.3"><!--s.23.16.3.0.embeds--><!--s.23.17.3.1.attachments--><!--s.23.18.3.2.components--><!--s.23.19.3.3.reactions--><!--s.23.20.3.4.thread--></div></div></div></discord-message><discord-message id="m-1191672401893806130" timestamp="01/02/2024 09:20 AM" edited="false" highlight="false" profile="948233689295355995" class="discord-message hydrated" s-id="25" c-id="0.12"><!--r.25--><!--o.0.66--><!--s.25.0.0.0.reply--><div class="discord-message-inner" c-id="25.1.0.1"><div class="discord-author-avatar" c-id="25.2.1.0"><img src="https://cdn.discordapp.com/avatars/948233689295355995/92a901002511c7fe73c8d02b558ddbdb.webp?size=64" alt="erikcorry" c-id="25.3.2.0"></div><div class="discord-message-content" c-id="25.4.1.1"><span class="discord-author-info" c-id="25.5.2.0"><span class="discord-author-username" c-id="25.6.3.0"><!--t.25.7.4.0-->erikcorry</span><!--t.25.8.3.1--> </span><span class="discord-message-timestamp" c-id="25.9.2.1"><!--t.25.10.3.0-->01/02/2024 09:20 AM</span><div class="discord-message-body" c-id="25.11.2.2"><span class="discord-message-markup" c-id="25.12.3.0"><!--s.25.13.4.0.--><!--t.0.66-->Actually it sometimes works with max-tasks=1 (the default).</span><!--t.25.14.3.1--> </div><div class="discord-message-compact-indent" c-id="25.15.2.3"><!--s.25.16.3.0.embeds--><!--s.25.17.3.1.attachments--><!--s.25.18.3.2.components--><!--s.25.19.3.3.reactions--><!--s.25.20.3.4.thread--></div></div></div></discord-message><discord-message id="m-1191672732195229786" timestamp="01/02/2024 09:21 AM" edited="false" highlight="false" profile="948233689295355995" class="discord-message hydrated" s-id="26" c-id="0.13"><!--r.26--><!--o.0.67--><!--o.0.68--><!--o.0.69--><!--o.0.70--><!--o.0.71--><!--s.26.0.0.0.reply--><div class="discord-message-inner" c-id="26.1.0.1"><div class="discord-author-avatar" c-id="26.2.1.0"><img src="https://cdn.discordapp.com/avatars/948233689295355995/92a901002511c7fe73c8d02b558ddbdb.webp?size=64" alt="erikcorry" c-id="26.3.2.0"></div><div class="discord-message-content" c-id="26.4.1.1"><span class="discord-author-info" c-id="26.5.2.0"><span class="discord-author-username" c-id="26.6.3.0"><!--t.26.7.4.0-->erikcorry</span><!--t.26.8.3.1--> </span><span class="discord-message-timestamp" c-id="26.9.2.1"><!--t.26.10.3.0-->01/02/2024 09:21 AM</span><div class="discord-message-body" c-id="26.11.2.2"><span class="discord-message-markup" c-id="26.12.3.0"><!--s.26.13.4.0.--><!--t.0.67-->Note the <discord-inline-code class="hydrated" s-id="27" c-id="0.68"><!--r.27--><!--o.0.72--><code c-id="27.0.0.0"><!--s.27.1.1.0.--><!--t.0.72-->else</code></discord-inline-code><!--t.0.69--> in front of the <discord-inline-code class="hydrated" s-id="28" c-id="0.70"><!--r.28--><!--o.0.73--><code c-id="28.0.0.0"><!--s.28.1.1.0.--><!--t.0.73-->if request.path == "/"</code></discord-inline-code><!--t.0.71--> which makes sure you don't do the whole router when it's a websocket connection.</span><!--t.26.14.3.1--> </div><div class="discord-message-compact-indent" c-id="26.15.2.3"><!--s.26.16.3.0.embeds--><!--s.26.17.3.1.attachments--><!--s.26.18.3.2.components--><!--s.26.19.3.3.reactions--><!--s.26.20.3.4.thread--></div></div></div></discord-message><discord-message id="m-1191777346391384155" timestamp="01/02/2024 04:17 PM" edited="false" highlight="false" profile="680454302786912427" class="discord-message hydrated" s-id="29" c-id="0.14"><!--r.29--><!--o.0.74--><!--s.29.0.0.0.reply--><div class="discord-message-inner" c-id="29.1.0.1"><div class="discord-author-avatar" c-id="29.2.1.0"><img src="https://cdn.discordapp.com/embed/avatars/0.png" alt="davidg238" c-id="29.3.2.0"></div><div class="discord-message-content" c-id="29.4.1.1"><span class="discord-author-info" c-id="29.5.2.0"><span class="discord-author-username" c-id="29.6.3.0"><!--t.29.7.4.0-->davidg238</span><!--t.29.8.3.1--> </span><span class="discord-message-timestamp" c-id="29.9.2.1"><!--t.29.10.3.0-->01/02/2024 04:17 PM</span><div class="discord-message-body" c-id="29.11.2.2"><span class="discord-message-markup" c-id="29.12.3.0"><!--s.29.13.4.0.--><!--t.0.74-->doh.  thanks.</span><!--t.29.14.3.1--> </div><div class="discord-message-compact-indent" c-id="29.15.2.3"><!--s.29.16.3.0.embeds--><!--s.29.17.3.1.attachments--><!--s.29.18.3.2.components--><!--s.29.19.3.3.reactions--><!--s.29.20.3.4.thread--></div></div></div></discord-message><discord-message id="m-1192608609465532468" timestamp="01/04/2024 11:20 PM" edited="false" highlight="false" profile="680454302786912427" class="discord-message hydrated" s-id="30" c-id="0.15"><!--r.30--><!--o.0.75--><!--o.0.76--><!--o.0.77--><!--o.0.78--><!--o.0.79--><!--o.0.80--><!--o.0.81--><!--o.0.82--><!--o.0.83--><!--o.0.84--><!--o.0.85--><!--o.0.86--><!--o.0.87--><!--o.0.89--><!--o.0.90--><!--o.0.91--><!--o.0.92--><!--o.0.93--><!--o.0.94--><!--o.0.95--><!--o.0.96--><!--o.0.97--><!--o.0.98--><!--o.0.99--><!--o.0.100--><!--o.0.101--><!--o.0.102--><!--o.0.103--><!--s.30.0.0.0.reply--><div class="discord-message-inner" c-id="30.1.0.1"><div class="discord-author-avatar" c-id="30.2.1.0"><img src="https://cdn.discordapp.com/embed/avatars/0.png" alt="davidg238" c-id="30.3.2.0"></div><div class="discord-message-content" c-id="30.4.1.1"><span class="discord-author-info" c-id="30.5.2.0"><span class="discord-author-username" c-id="30.6.3.0"><!--t.30.7.4.0-->davidg238</span><!--t.30.8.3.1--> </span><span class="discord-message-timestamp" c-id="30.9.2.1"><!--t.30.10.3.0-->01/04/2024 11:20 PM</span><div class="discord-message-body" c-id="30.11.2.2"><span class="discord-message-markup" c-id="30.12.3.0"><!--s.30.13.4.0.--><!--t.0.75-->Does anything jump out at you as you read the below? <br c-id="0.76"><!--t.0.77-->Summary: <br c-id="0.78"><!--t.0.79-->Chrome works after ~30 sec (see  -- active -- , below "Click Me" button) <br c-id="0.80"><!--t.0.81-->Firefox fails immediately.<br c-id="0.82"><br c-id="0.83"><!--t.0.84-->Referencing  examples/counter.toit in <a href="https://github.com/davidg238/webd" target="_blank" rel="noreferrer" c-id="0.85">https://github.com/davidg238/webd</a><!--t.0.86--> , when I run:<br c-id="0.87"> <discord-inline-code class="hydrated" s-id="31" c-id="0.89"><!--r.31--><!--o.0.104--><code c-id="31.0.0.0"><!--s.31.1.1.0.--><!--t.0.104--> jag run counter.toit</code></discord-inline-code><br c-id="0.90"><!--t.0.91-->and view the page on Chrome, I get:<br c-id="0.92"><discord-code-block language="" code="Starting web server at 192.168.0.137:8080
DEBUG: client connected {peer: 192.168.0.174:38064}
DEBUG: incoming request {peer: 192.168.0.174:38064, path: /}
DEBUG: client connected {peer: 192.168.0.174:38078}
<after ~30 seconds>
DEBUG: connection ended {peer: 192.168.0.174:38078, reason: DEADLINE_EXCEEDED}
DEBUG: client connected {peer: 192.168.0.174:38082}
DEBUG: incoming request {peer: 192.168.0.174:38082, path: /ws}
websocket request invoked
DEBUG: connection ended {peer: 192.168.0.174:38064, reason: DEADLINE_EXCEEDED}
DEBUG: client socket detached {peer: 192.168.0.174:38082}" class="discord-code-block-pre discord-code-block-pre--multiline language hydrated" s-id="32" c-id="0.93"><!--r.32--><code class="hljs language-plaintext" c-id="32.0.0.0">Starting web server at 192.168.0.137:8080
DEBUG: client connected {peer: 192.168.0.174:38064}
DEBUG: incoming request {peer: 192.168.0.174:38064, path: /}
DEBUG: client connected {peer: 192.168.0.174:38078}
&lt;after ~30 seconds&gt;
DEBUG: connection ended {peer: 192.168.0.174:38078, reason: DEADLINE_EXCEEDED}
DEBUG: client connected {peer: 192.168.0.174:38082}
DEBUG: incoming request {peer: 192.168.0.174:38082, path: /ws}
websocket request invoked
DEBUG: connection ended {peer: 192.168.0.174:38064, reason: DEADLINE_EXCEEDED}
DEBUG: client socket detached {peer: 192.168.0.174:38082}</code></discord-code-block><br c-id="0.94"><br c-id="0.95"><!--t.0.96-->I get the first 3 lines on the console, and the page renders immediately. <br c-id="0.97"><!--t.0.98-->The websocket shows "pending" in the Chrome developer tools/network tab. <br c-id="0.99"><!--t.0.100-->Afer about 30 seconds, the websocket status changes to 101 and the button works. <br c-id="0.101"><!--t.0.102-->There is no apparent request for the favicon.ico</span><!--t.30.14.3.1--> </div><div class="discord-message-compact-indent" c-id="30.15.2.3"><!--s.30.16.3.0.embeds--><discord-embed embed-title="GitHub - davidg238/webd" slot="embeds" color="#1e2327" thumbnail="https://images-ext-1.discordapp.net/external/5X9pKdwqUFkYAUeyjB-WhFIAWhRMzeRH86JxFNNLbsk/https/opengraph.githubassets.com/931061948949d71c1f9492bae390c2254b9479ba76435d07d2fdea0cd6938099/davidg238/webd" url="https://github.com/davidg238/webd" class="hydrated" s-id="33" c-id="0.103"><!--r.33--><!--o.0.105--><div class="discord-embed" c-id="33.0.0.0"><div class="discord-left-border" c-id="33.1.1.0" style="background-color: #1e2327;"></div><div class="discord-embed-root" c-id="33.2.1.1"><div class="discord-embed-wrapper" c-id="33.3.2.0"><div class="discord-embed-grid" c-id="33.4.3.0"><div class="discord-embed-title" c-id="33.5.4.0"><a href="https://github.com/davidg238/webd" target="_blank" rel="noopener noreferrer" c-id="33.6.5.0"><!--t.33.7.6.0-->GitHub - davidg238/webd</a></div><!--s.33.8.4.1.description--><discord-embed-description slot="description" class="discord-embed-description hydrated" s-id="34" c-id="0.105"><!--r.34--><!--o.0.106--><!--s.34.0.0.0.--><!--t.0.106-->Contribute to davidg238/webd development by creating an account on GitHub.</discord-embed-description><!--s.33.9.4.2.fields--><img src="https://images-ext-1.discordapp.net/external/5X9pKdwqUFkYAUeyjB-WhFIAWhRMzeRH86JxFNNLbsk/https/opengraph.githubassets.com/931061948949d71c1f9492bae390c2254b9479ba76435d07d2fdea0cd6938099/davidg238/webd" alt="" class="discord-embed-thumbnail" c-id="33.10.4.3"><!--s.33.11.4.4.footer--></div></div></div></div></discord-embed><!--s.30.17.3.1.attachments--><!--s.30.18.3.2.components--><!--s.30.19.3.3.reactions--><!--s.30.20.3.4.thread--></div></div></div></discord-message><discord-message id="m-1192608655766470696" timestamp="01/04/2024 11:21 PM" edited="false" highlight="false" profile="680454302786912427" class="discord-message hydrated" s-id="35" c-id="0.16"><!--r.35--><!--o.0.107--><!--o.0.108--><!--o.0.109--><!--o.0.110--><!--o.0.111--><!--o.0.112--><!--o.0.113--><!--o.0.114--><!--o.0.115--><!--o.0.117--><!--o.0.118--><!--o.0.119--><!--o.0.120--><!--o.0.121--><!--s.35.0.0.0.reply--><div class="discord-message-inner" c-id="35.1.0.1"><div class="discord-author-avatar" c-id="35.2.1.0"><img src="https://cdn.discordapp.com/embed/avatars/0.png" alt="davidg238" c-id="35.3.2.0"></div><div class="discord-message-content" c-id="35.4.1.1"><span class="discord-author-info" c-id="35.5.2.0"><span class="discord-author-username" c-id="35.6.3.0"><!--t.35.7.4.0-->davidg238</span><!--t.35.8.3.1--> </span><span class="discord-message-timestamp" c-id="35.9.2.1"><!--t.35.10.3.0-->01/04/2024 11:21 PM</span><div class="discord-message-body" c-id="35.11.2.2"><span class="discord-message-markup" c-id="35.12.3.0"><!--s.35.13.4.0.--><!--t.0.107-->On Firefox, I get:<br c-id="0.108"><discord-code-block language="" code="Starting web server at 192.168.0.137:8080
DEBUG: client connected {peer: 192.168.0.174:35648}
DEBUG: incoming request {peer: 192.168.0.174:35648, path: /}
DEBUG: client connected {peer: 192.168.0.174:35664}
DEBUG: incoming request {peer: 192.168.0.174:35664, path: /ws}
websocket request invoked
DEBUG: connection ended {peer: 192.168.0.174:35664}
DEBUG: connection ended {peer: 192.168.0.174:35648, reason: DEADLINE_EXCEEDED}" class="discord-code-block-pre discord-code-block-pre--multiline language hydrated" s-id="36" c-id="0.109"><!--r.36--><code class="hljs language-plaintext" c-id="36.0.0.0">Starting web server at 192.168.0.137:8080
DEBUG: client connected {peer: 192.168.0.174:35648}
DEBUG: incoming request {peer: 192.168.0.174:35648, path: /}
DEBUG: client connected {peer: 192.168.0.174:35664}
DEBUG: incoming request {peer: 192.168.0.174:35664, path: /ws}
websocket request invoked
DEBUG: connection ended {peer: 192.168.0.174:35664}
DEBUG: connection ended {peer: 192.168.0.174:35648, reason: DEADLINE_EXCEEDED}</code></discord-code-block><br c-id="0.110"><!--t.0.111-->immediately.  In the developer/network tab, <br c-id="0.112"><!--t.0.113-->In the URL window: <br c-id="0.114"><discord-code-block language="" code="status 200, method get, file /  
status 404, method get, file favicon.ico  
status 400, method get, file ws  " class="discord-code-block-pre discord-code-block-pre--multiline language hydrated" s-id="37" c-id="0.115"><!--r.37--><code class="hljs language-plaintext" c-id="37.0.0.0">status 200, method get, file /  
status 404, method get, file favicon.ico  
status 400, method get, file ws</code></discord-code-block> <br c-id="0.117"><br c-id="0.118"><!--t.0.119-->In the request window: <br c-id="0.120"><discord-code-block language="" code="GET http://192.168.0.137:8080/  [HTTP/1.1 200 ok 190ms]
GET http://192.168.0.137:8080/favicon.ico  [HTTP1.1 404 Not Found 0ms]
GET ws://192.168.0.137:8080/ws  [HTTP/1.1 400 No Connection: Upgrade 41mS]" class="discord-code-block-pre discord-code-block-pre--multiline language hydrated" s-id="38" c-id="0.121"><!--r.38--><code class="hljs language-plaintext" c-id="38.0.0.0">GET http://192.168.0.137:8080/  [HTTP/1.1 200 ok 190ms]
GET http://192.168.0.137:8080/favicon.ico  [HTTP1.1 404 Not Found 0ms]
GET ws://192.168.0.137:8080/ws  [HTTP/1.1 400 No Connection: Upgrade 41mS]</code></discord-code-block></span><!--t.35.14.3.1--> </div><div class="discord-message-compact-indent" c-id="35.15.2.3"><!--s.35.16.3.0.embeds--><!--s.35.17.3.1.attachments--><!--s.35.18.3.2.components--><!--s.35.19.3.3.reactions--><!--s.35.20.3.4.thread--></div></div></div></discord-message><discord-message id="m-1192744494685233244" timestamp="01/05/2024 08:20 AM" edited="true" highlight="false" profile="1101219832344629358" class="discord-message hydrated" s-id="39" c-id="0.17"><!--r.39--><!--o.0.122--><!--o.0.123--><!--o.0.124--><!--o.0.125--><!--o.0.126--><!--o.0.127--><!--o.0.128--><!--o.0.129--><!--o.0.130--><!--s.39.0.0.0.reply--><div class="discord-message-inner" c-id="39.1.0.1"><div class="discord-author-avatar" c-id="39.2.1.0"><img src="https://cdn.discordapp.com/embed/avatars/4.png" alt="hhv0001" c-id="39.3.2.0"></div><div class="discord-message-content" c-id="39.4.1.1"><span class="discord-author-info" c-id="39.5.2.0"><span class="discord-author-username" c-id="39.6.3.0"><!--t.39.7.4.0-->hhv0001</span><!--t.39.8.3.1--> </span><span class="discord-message-timestamp" c-id="39.9.2.1"><!--t.39.10.3.0-->01/05/2024 08:20 AM</span><div class="discord-message-body" c-id="39.11.2.2"><span class="discord-message-markup" c-id="39.12.3.0"><!--s.39.13.4.0.--><!--t.0.122-->That "30 seconds" jumps out. That's the copious timeout that can be reduced. You'll probably also need to up the number of tasks the server uses like Erik said, so add these to the server: <br c-id="0.123"><!--t.0.124--> --max-tasks=6 --read_timeout=d<br c-id="0.125"><!--t.0.126-->where d is<br c-id="0.127"><!--t.0.128-->d := Duration --ms=1000<br c-id="0.129"><!--t.0.130-->or something smaller than 30 seconds that works for you.</span><span class="discord-message-edited" c-id="39.14.3.1"><!--t.39.15.4.0-->(edited)</span></div><div class="discord-message-compact-indent" c-id="39.16.2.3"><!--s.39.17.3.0.embeds--><!--s.39.18.3.1.attachments--><!--s.39.19.3.2.components--><!--s.39.20.3.3.reactions--><!--s.39.21.3.4.thread--></div></div></div></discord-message><discord-message id="m-1192843649629827212" timestamp="01/05/2024 02:54 PM" edited="false" highlight="false" profile="680454302786912427" class="discord-message hydrated" s-id="40" c-id="0.18"><!--r.40--><!--o.0.131--><!--s.40.0.0.0.reply--><div class="discord-message-inner" c-id="40.1.0.1"><div class="discord-author-avatar" c-id="40.2.1.0"><img src="https://cdn.discordapp.com/embed/avatars/0.png" alt="davidg238" c-id="40.3.2.0"></div><div class="discord-message-content" c-id="40.4.1.1"><span class="discord-author-info" c-id="40.5.2.0"><span class="discord-author-username" c-id="40.6.3.0"><!--t.40.7.4.0-->davidg238</span><!--t.40.8.3.1--> </span><span class="discord-message-timestamp" c-id="40.9.2.1"><!--t.40.10.3.0-->01/05/2024 02:54 PM</span><div class="discord-message-body" c-id="40.11.2.2"><span class="discord-message-markup" c-id="40.12.3.0"><!--s.40.13.4.0.--><!--t.0.131-->Thanks.  That made Chrome usable,</span><!--t.40.14.3.1--> </div><div class="discord-message-compact-indent" c-id="40.15.2.3"><!--s.40.16.3.0.embeds--><!--s.40.17.3.1.attachments--><!--s.40.18.3.2.components--><!--s.40.19.3.3.reactions--><!--s.40.20.3.4.thread--></div></div></div></discord-message><discord-message id="m-1192843799525871656" timestamp="01/05/2024 02:55 PM" edited="false" highlight="false" profile="680454302786912427" class="discord-message hydrated" s-id="41" c-id="0.19"><!--r.41--><!--o.0.132--><!--s.41.0.0.0.reply--><div class="discord-message-inner" c-id="41.1.0.1"><div class="discord-author-avatar" c-id="41.2.1.0"><img src="https://cdn.discordapp.com/embed/avatars/0.png" alt="davidg238" c-id="41.3.2.0"></div><div class="discord-message-content" c-id="41.4.1.1"><span class="discord-author-info" c-id="41.5.2.0"><span class="discord-author-username" c-id="41.6.3.0"><!--t.41.7.4.0-->davidg238</span><!--t.41.8.3.1--> </span><span class="discord-message-timestamp" c-id="41.9.2.1"><!--t.41.10.3.0-->01/05/2024 02:55 PM</span><div class="discord-message-body" c-id="41.11.2.2"><span class="discord-message-markup" c-id="41.12.3.0"><!--s.41.13.4.0.--><!--t.0.132-->Firefox still fails, will look further</span><!--t.41.14.3.1--> </div><div class="discord-message-compact-indent" c-id="41.15.2.3"><!--s.41.16.3.0.embeds--><!--s.41.17.3.1.attachments--><!--s.41.18.3.2.components--><!--s.41.19.3.3.reactions--><!--s.41.20.3.4.thread--></div></div></div></discord-message><div c-id="0.20" style="text-align: center; width: 100%;">18 messages in total </div></discord-messages><script>const s=document.querySelectorAll(".discord-spoiler");s.forEach(s=>s.addEventListener("click",()=>{if(s.classList.contains("discord-spoiler")){s.classList.remove("discord-spoiler");s.classList.add("discord-spoiler--revealed");}}));</script></body></html>